<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Functions - Cloud Functors</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../assets/custom.css">
        <link rel="stylesheet" href="../../assets/mdbook-admonish.css">
        <link rel="stylesheet" href="../.././mdbook-admonish.css">

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><li class="part-title">Introduction</li><li class="chapter-item "><a href="../../introduction/about.html">About</a></li><li class="chapter-item "><div>Rationale</div></li><li class="chapter-item "><div>Concepts</div></li><li class="chapter-item "><a href="../../introduction/features.html">Features</a></li><li class="chapter-item affix "><li class="part-title">Getting Started</li><li class="chapter-item "><a href="../../installation.html">Installation</a></li><li class="chapter-item "><a href="../../quick-start.html">Quick Start</a></li><li class="chapter-item "><div>Examples</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><div>Job tracker</div></li><li class="chapter-item "><div>Chat</div></li></ol></li><li class="chapter-item "><li class="part-title">Reference</li><li class="chapter-item "><a href="../../reference/specification.html">Specification</a></li><li class="chapter-item "><a href="../../reference/config.html">Config</a></li><li class="chapter-item expanded "><a href="../../reference/entities.html">Entities</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../reference/entities/functions.html" class="active">Functions</a></li><li class="chapter-item "><a href="../../reference/entities/events.html">Events</a></li><li class="chapter-item "><a href="../../reference/entities/routes.html">Routes</a></li><li class="chapter-item "><a href="../../reference/entities/queues.html">Queues</a></li><li class="chapter-item "><a href="../../reference/entities/mutations.html">Mutations</a></li><li class="chapter-item "><a href="../../reference/entities/channels.html">Channels</a></li><li class="chapter-item "><a href="../../reference/entities/pages.html">Pages</a></li><li class="chapter-item "><a href="../../reference/entities/states.html">States</a></li><li class="chapter-item "><div>Tables</div></li></ol></li><li class="chapter-item "><a href="../../reference/cli.html">CLI</a></li><li class="chapter-item affix "><li class="part-title">Workflows</li><li class="chapter-item "><div>Design</div></li><li class="chapter-item "><a href="../../workflows/develop.html">Develop</a></li><li class="chapter-item "><a href="../../workflows/release.html">Release</a></li><li class="chapter-item "><div>Canarys</div></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Cloud Functors</h1>

                    <div class="right-buttons">
                        <a href="https://github.com/tc-functors/tc" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="functions"><a class="header" href="#functions">Functions</a></h1>
<ul>
<li><a href="#1-definitions">1. Definitions</a>
<ul>
<li><a href="#11-topology-functions">1.1 Topology functions</a></li>
<li><a href="#12-interned-functions">1.2 Interned functions</a></li>
<li><a href="#13-standalone-functions">1.3 Standalone functions</a></li>
</ul>
</li>
<li><a href="#2-components">2. Components</a>
<ul>
<li><a href="#21-permissions">2.1 Permissions</a></li>
<li><a href="#22-environment-variables">2.2 Environment variables</a></li>
<li><a href="#23-update-components">2.3 Update components</a></li>
</ul>
</li>
<li><a href="#3-dependencies">3. Dependencies</a>
<ul>
<li><a href="#31-inline">3.1 Inline</a></li>
<li><a href="#32-layer">3.2 Layer</a></li>
<li><a href="#33-image">3.3 Image</a>
<ul>
<li><a href="#331-syncing-base-images">3.3.1 Syncing base images</a></li>
<li><a href="#332-inspecting-the-images">3.3.2 Inspecting the images</a></li>
<li><a href="#333-external-parent-image">3.3.3 External parent image</a></li>
</ul>
</li>
<li><a href="#34-filesystems">3.4 Filesystems</a></li>
</ul>
</li>
<li><a href="#4-providers">4. Providers</a></li>
<li><a href="#5-testing">5. Testing</a>
<ul>
<li><a href="#51-invoke">5.1 Invoke</a></li>
<li><a href="#52-emulate">5.2 Emulate</a></li>
</ul>
</li>
</ul>
<h2 id="1-definitions"><a class="header" href="#1-definitions">1. Definitions</a></h2>
<p>There are 3 kinds of function definitions:</p>
<ol>
<li>Topology functions</li>
<li>Interned functions</li>
<li>Standalone functions</li>
</ol>
<h3 id="11-topology-functions"><a class="header" href="#11-topology-functions">1.1 Topology functions</a></h3>
<p>tc discovers functions in the current directory. A function is any directory that contains a</p>
<ol>
<li>handler.{py,rb,clj,js} file  and/or</li>
<li>function.yml file</li>
</ol>
<p>At it's simplest, a function directory (say foo) looks as follows:</p>
<pre><code class="language-sh">foo/
 - handler.{py, rb, js, clj}
</code></pre>
<p>tc <em>infers</em> the kind of function, runtime and build instructions. However, we can be more specific as follows in a <code>function.json</code></p>
<pre><code class="language-yaml">name: foo
runtime:
  lang: python3.11
  handler: handler.handler
</code></pre>
<h3 id="12-interned-functions"><a class="header" href="#12-interned-functions">1.2 Interned functions</a></h3>
<p>Interned functions are those that are explicitly defined in topology.yml</p>
<pre><code class="language-yaml">
functions:
  fun1:
    uri: ../my-fun1
  fun2:
    uri: ../my-fun2

</code></pre>
<h3 id="13-standalone-functions"><a class="header" href="#13-standalone-functions">1.3 Standalone functions</a></h3>
<p>A function that does belong to a topology or has no topology defined is a <em>standalone</em> function.</p>
<pre><code class="language-yaml">name: foo
runtime:
  lang: python3.11
  handler: handler.handler
</code></pre>
<h2 id="2-components"><a class="header" href="#2-components">2. Components</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Key</th><th>Default</th><th>Optional?</th><th>Comments</th></tr></thead><tbody>
<tr><td>lang</td><td>Inferred</td><td>yes</td><td></td></tr>
<tr><td>handler</td><td>handler.handler</td><td></td><td></td></tr>
<tr><td>package_type</td><td>zip</td><td></td><td>possible values: zip, image</td></tr>
<tr><td>uri</td><td>file:./lambda.zip</td><td></td><td></td></tr>
<tr><td>mount_fs</td><td>false</td><td>yes</td><td></td></tr>
<tr><td>snapstart</td><td>false</td><td>yes</td><td></td></tr>
<tr><td>memory</td><td>128</td><td>yes</td><td></td></tr>
<tr><td>timeout</td><td>30</td><td>yes</td><td></td></tr>
<tr><td>provisioned_concurrency</td><td>0</td><td>yes</td><td></td></tr>
<tr><td>reserved_concurrency</td><td>0</td><td>yes</td><td></td></tr>
<tr><td>layers</td><td>[]</td><td>yes</td><td></td></tr>
<tr><td>extensions</td><td>[]</td><td>yes</td><td></td></tr>
<tr><td>environment</td><td>{}</td><td>yes</td><td>Environment variables</td></tr>
</tbody></table>
</div>
<h3 id="21-permissions"><a class="header" href="#21-permissions">2.1 Permissions</a></h3>
<p>By default, tc infers permissions and sets the right boundaries in the sandbox. However, you may need to override the permissions by specifying a custom <em>roles</em> file in <code>$INFRA_ROOT</code> (say $GIT_ROOT/infrastructure/tc/TOPOLOGY-NAME/roles/FUNCTION-NAME.json. The contents of the roles file is typically the IAM policy.</p>
<h3 id="22-environment-variables"><a class="header" href="#22-environment-variables">2.2 Environment variables</a></h3>
<p>Specify env variables in $GIT_ROOT/infrastructure/tc/TOPOLOGY-NAME/vars/FUNCTION-NAME.json</p>
<pre><code class="language-json">{
  &quot;default&quot;: {
    &quot;timeout&quot;: 120,
    &quot;memory_size&quot;: 128,
    &quot;environment&quot;: {
      &quot;API_KEY&quot;: &quot;ssm:/path/to/api-key&quot;,
      &quot;DB_HOST&quot;: &quot;dev.db.net&quot;
    }
  },
  &quot;prod&quot;: {
    &quot;timeout&quot;: 60,
    &quot;memory_size&quot;: 1024,
    &quot;environment&quot;: {
      &quot;API_KEY&quot;: &quot;ssm:/path/to/api-key&quot;,
      &quot;DB_HOST&quot;: &quot;prod.db.net&quot;
    }
  },
  &quot;SANDBOX-NAME&quot;: {
    &quot;timeout&quot;: 60,
    &quot;environment&quot;: {
      &quot;API_KEY&quot;: &quot;ssm:/path/to/api-key&quot;
    }
  }
}

</code></pre>
<p>The <code>vars</code> or runtime file is map of default and sandbox-specific overrides. Environment variables in the runtime file can be either an URI or plain text. Supported URIs are <code>ssm:/</code> , <code>s3:/</code> and <code>file:/</code>. If an URI is specified, tc resolves the values and injects them as actual values when creating the lambda. Decryption using <code>extensions</code> is also available. See Extensions.</p>
<h3 id="23-update-components"><a class="header" href="#23-update-components">2.3 Update components</a></h3>
<p>tc provides mechanisms to update specific component of entities or topology in a given sandbox. This is incredibly useful when developing your core topology.</p>
<pre><code class="language-sh">tc update -s sandbox -e env -c functions/layers
tc update -s sandbox -e env -c functions/vars
tc update -s sandbox -e env -c functions/concurrency
tc update -s sandbox -e env -c functions/runtime
tc update -s sandbox -e env -c functions/tags
tc update -s sandbox -e env -c functions/roles
tc update -s sandnox -e env -c functions/function-name
</code></pre>
<h2 id="3-dependencies"><a class="header" href="#3-dependencies">3. Dependencies</a></h2>
<p><code>tc</code> has a sophisticated function <code>builder</code> that can build different kinds of artifacts with various language runtimes (Clojure, Janet, Rust, Ruby, Python, Node)</p>
<p>In the simplest case, when there are no dependencies in a function, we can specify how the code is packed (zipped) as follows in <code>function.json</code>:</p>
<pre><code class="language-yaml">name: simple-function
runtime:
  lang: python3.10
  package_type: zip
  handler: handler.handler
</code></pre>
<p><a href="https://github.com/informed-labs/tc/blob/main/examples/functions/python-basic/function.json">Example</a></p>
<p>and then <code>tc create -s &lt;sandbox&gt; -e &lt;env&gt;</code> builds this function using the given <code>command</code> and creates it in the given sandbox and env.</p>
<h3 id="31-inline"><a class="header" href="#31-inline">3.1 Inline</a></h3>
<p>The above is a pretty trivial example and it gets complicated as we start adding more dependencies. If the dependencies are reasonably small (&lt; 50MB), we can inline those in the code's artifact (lambda.zip).</p>
<pre><code class="language-yaml">name: python-inline-example
runtime:
  lang: python3.12
  package_type: zip
  handler: handler.handler
build:
  kind: Inline
  command: zip -9 -q lambda.zip *.py
</code></pre>
<p><a href="https://github.com/informed-labs/tc/blob/main/examples/functions/python-inline/function.yml">Example</a></p>
<p><code>tc create -s &lt;sandbox&gt; -e &lt;env&gt;</code> will implicitly build the artifact with <em>inlined</em> deps and create the function in the given sandbox and env. The dependencies are typically in <code>lib/</code> including shared objects (.so files).</p>
<div id="admonition-info" class="admonition admonish-info" role="note" aria-labelledby="admonition-info-title">
<div class="admonition-title">
<div id="admonition-info-title">
<p>Info</p>
</div>
<a class="admonition-anchor-link" href="#admonition-info"></a>
</div>
<div>
<p>tc builds the <em>inlined</em> zip using docker and the builder image that is compatible with the lambda runtime image.</p>
</div>
</div>
<h3 id="32-layer"><a class="header" href="#32-layer">3.2 Layer</a></h3>
<p>If <code>inline</code> build is heavy, we can try to layer the dependencies:</p>
<pre><code class="language-yaml">name: ppd
runtime:
  lang: python3.10
  package_type: zip
  handler: handler.handler
  layers:
   - ppd-layer
build:
  pre:
   - yum install -y git
   - yum install -y gcc gcc-c++
  kind: Layer

</code></pre>
<p>Note that we have specified the list of layers the function uses. The layer itself can be built independent of the function, unlike <code>Inline</code> build kind.</p>
<pre><code>tc build --kind layer
tc publish --name ppd-layer
</code></pre>
<p>We can then create or update the function with this layer. At times, we may want to update just the layers in an existing sandboxed function</p>
<pre><code class="language-sh">tc update -s &lt;sandbox&gt; -e &lt;env&gt; -c layers

</code></pre>
<div id="admonition-info-1" class="admonition admonish-info" role="note" aria-labelledby="admonition-info-1-title">
<div class="admonition-title">
<div id="admonition-info-1-title">
<p>Info</p>
</div>
<a class="admonition-anchor-link" href="#admonition-info-1"></a>
</div>
<div>
<p>AWS has a limit on the number of layers and size of each zipped layer. tc automatically splits the layer into chunks if it exceeds the size limit (and still within the upper total limit of 256MB)</p>
</div>
</div>
<h3 id="33-image"><a class="header" href="#33-image">3.3 Image</a></h3>
<p>While <code>Layer</code> and <code>Inline</code> build kind should suffice to pack most dependencies, there are cases where 250MB is not good enough. Container <code>Image</code> kind is a good option. However, building the deps and updating just the code is challenging using pure docker as you need to know the sequence to build. <code>tc</code> provides a mechanism to build a <code>tree</code> of images. For example:</p>
<pre><code class="language-yaml">name: python-image-tree-example
runtime:
  lang: python3.10
  package_type: image
  handler: handler.handler
build:
  kind: Image
  images:
    base:
      version: 0.1.1
      commands:
      - yum install -y git wget unzip
      - yum install -y gcc gcc-c++ libXext libSM libXrender
    code:
      parent: base
      commands: []
</code></pre>
<p><a href="https://github.com/informed-labs/tc/blob/main/examples/functions/python-image/function.yml#L1">Example</a></p>
<p>In the above example, we define the <code>base</code> image with dependencies and <code>code</code> image that packs just the code. Note that <code>code</code>  references <code>base</code> as the <em>parent</em>. Effectively, we can build a tree of images (say base dependencies, models, assets and code). These <code>images</code> can be built at any point in the lifecycle of the function. To build the <code>base</code> image do:</p>
<pre><code class="language-sh">tc build --image base --publish
</code></pre>
<p>When <code>--publish</code> is specified, it publishes to the configured ECR repo [See Configuration]. Alternatively, <code>TC_ECR_REPO</code> env variable can be specified to override the config. The value of variable is the ECR repo URI</p>
<p>With python functions, the image can be built either by having a 'requirements.txt' file in the function directory or a pyproject.toml. <code>tc build</code> works with requirements.txt and poetry.</p>
<p>When all &quot;parent&quot; images have been built, <code>tc create</code> will create the <code>code</code> image just-in-time. The tag is the SHA1 checksum of the function directory. The code tag is typically of the format &quot;{{repo}}/code:req-0d4043e5ae0ebc83f486ff26e8e30f3bd404b707&quot;&quot;</p>
<p>We can also optionally build the <code>code</code> image.</p>
<pre><code>tc build --image code --publish
</code></pre>
<p>Note that the child image uses the parent's version of the image as specified in the parent's block.</p>
<h4 id="331-syncing-base-images"><a class="header" href="#331-syncing-base-images">3.3.1 Syncing base images</a></h4>
<p>While we can <code>docker pull</code> the base and code images locally, it is cumbersome to do it for all functions recursively by resolving their versions. <code>tc build --sync</code> pulls the base and code images based on current function checksums. Having a copy the base or parent code images allows us to do incremental updates much faster.</p>
<h4 id="332-inspecting-the-images"><a class="header" href="#332-inspecting-the-images">3.3.2 Inspecting the images</a></h4>
<p>We can run <code>tc build --shell</code> in the function directory and access the bash shell. The shell is always on the <code>code</code> image of the current function checksum. Note that the <code>code</code> image using the Lambda Runtime Image as the source image.</p>
<div id="admonition-info-2" class="admonition admonish-info" role="note" aria-labelledby="admonition-info-2-title">
<div class="admonition-title">
<div id="admonition-info-2-title">
<p>Info</p>
</div>
<a class="admonition-anchor-link" href="#admonition-info-2"></a>
</div>
<div>
<p>It is recommended that the ECR repo has a <namespace>/<label> format. The label can be the image labels specified in function.json:build (base, code etc)</p>
</div>
</div>
<h4 id="333-external-parent-image"><a class="header" href="#333-external-parent-image">3.3.3 External parent image</a></h4>
<p>At times, we may need to use a parent image that is shared and defined in another function or build. The following function definition is an example that shows how to specify a parent URI in code image-spec.</p>
<pre><code class="language-yaml">name: req-external-example
runtime:
  lang: python3.10
  package_type: image
  handler: handler.handler
build:
  kind: Image
  images:
    code:
      parent: '{{repo}}/base:req-0.1.1'
      commands: []


</code></pre>
<p><code>parent</code> in the <code>code</code> image-spec is an URI. This is also a way to pin the parent image.</p>
<h3 id="34-filesystems"><a class="header" href="#34-filesystems">3.4 Filesystems</a></h3>
<p>We can mount a filesystem by specifying a runtime attribute <code>mount_fs</code>:</p>
<pre><code class="language-yaml">name: fn-with-fs
runtime:
  lang: python3.11
  package_type: image
  mount_fs: true
  handler: handler.handler
</code></pre>
<h2 id="4-providers"><a class="header" href="#4-providers">4. Providers</a></h2>
<p>Default function provider is <code>Lambda</code>. We can make the same function code run in ECS Fargate with no change.</p>
<pre><code class="language-yaml">name: python-image-fargate
runtime:
  handler: &quot;python handler.py&quot;
  package_type: image
  provider: Fargate
build:
  kind: Image
  images:
    base:
      version: 0.1.1
      commands: []
    code:
      parent: base
      commands: []
</code></pre>
<h2 id="5-testing"><a class="header" href="#5-testing">5. Testing</a></h2>
<h3 id="51-invoke"><a class="header" href="#51-invoke">5.1 Invoke</a></h3>
<p>By default, tc picks up a <code>payload.json</code> file in the current directory. You could optionally specify a payload file</p>
<pre><code>tc invoke --sandbox main --env dev --payload payload.json
</code></pre>
<p>or via stdin</p>
<pre><code>cat payload.json | tc invoke --sandbox main --env dev
</code></pre>
<p>or as a param</p>
<pre><code>tc invoke --sandbox main --env dev --payload '{&quot;data&quot;: &quot;foo&quot;}'
</code></pre>
<h3 id="52-emulate"><a class="header" href="#52-emulate">5.2 Emulate</a></h3>
<p>To emulate the Lambda Runtime environment. The following command spins up a docker container with the defined layers in function.json, sets up the paths, environment variables, AWS access, local code and runtime parameters (mem, handlers etc)</p>
<pre><code class="language-sh">cd &lt;function-dir&gt;
tc emulate
</code></pre>
<p>To run in foreground</p>
<pre><code>tc emulate
</code></pre>
<p>You can now invoke a payload locally with this emulator</p>
<pre><code>tc invoke --local [--payload &lt;payload.json | json-str&gt;]
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../reference/entities.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../reference/entities/events.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../reference/entities.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../reference/entities/events.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../assets/mermaid.min.js"></script>
        <script src="../../assets/mermaid-init.js"></script>


    </div>
    </body>
</html>
